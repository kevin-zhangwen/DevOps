#!/usr/bin/env python3
"""
æ”¶é›† GitHub ä¸Šçƒ­é—¨çš„ DevOps ç›¸å…³é¡¹ç›®å’ŒæŠ€èƒ½
æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œæ›´æ–° trending.md
"""

import json
import requests
from datetime import datetime
import os

def fetch_github_trending():
    """
    è·å– GitHub Trending é¡µé¢å†…å®¹
    ç”±äº GitHub Trending æ²¡æœ‰å®˜æ–¹ APIï¼Œæˆ‘ä»¬é€šè¿‡æœç´¢ API è·å–çƒ­é—¨ DevOps é¡¹ç›®
    """
    
    # ä½¿ç”¨ GitHub Search API æœç´¢ DevOps ç›¸å…³çƒ­é—¨é¡¹ç›®
    query = "topic:devops stars:>1000 pushed:>2025-01-01"
    
    headers = {
        "Accept": "application/vnd.github.v3+json",
        "User-Agent": "DevOps-Trending-Collector"
    }
    
    # å¦‚æœæœ‰ GitHub Token å°±ä½¿ç”¨
    github_token = os.environ.get("GITHUB_TOKEN")
    if github_token:
        headers["Authorization"] = f"token {github_token}"
    
    results = []
    
    try:
        # æœç´¢ DevOps ç›¸å…³é¡¹ç›®
        url = f"https://api.github.com/search/repositories?q={query}&sort=stars&order=desc&per_page=20"
        response = requests.get(url, headers=headers, timeout=30)
        
        if response.status_code == 200:
            data = response.json()
            items = data.get("items", [])
            
            for item in items[:15]:
                results.append({
                    "name": item["full_name"],
                    "description": item.get("description", "æš‚æ— æè¿°"),
                    "url": item["html_url"],
                    "stars": item["stargazers_count"],
                    "language": item.get("language", "Unknown"),
                    "topics": item.get("topics", [])[:5],
                    "updated_at": item.get("updated_at", "")[:10]
                })
    except Exception as e:
        print(f"Error fetching GitHub trending: {e}")
    
    return results

def generate_markdown(trending_items):
    """ç”Ÿæˆ Markdown æ ¼å¼çš„æ€»ç»“æŠ¥å‘Š"""
    
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    md_content = f"""# ğŸ”¥ GitHub DevOps Trending Projects

**æ›´æ–°æ—¶é—´**: {now} (æ¯ 6 å°æ—¶æ›´æ–°)

---

## çƒ­é—¨é¡¹ç›® Top 15

| æ’å | é¡¹ç›®åç§° | Stars | è¯­è¨€ | æœ€è¿‘æ›´æ–° |
|------|----------|-------|------|----------|
"""
    
    for i, item in enumerate(trending_items, 1):
        topics_str = " ".join([f"`{t}`" for t in item.get("topics", [])[:3]])
        md_content += f"| {i} | [{item['name']}]({item['url']})<br/>{item['description'][:50]}... | â­ {item['stars']:,} | {item['language']} | {item['updated_at']} |\n"
    
    md_content += f"""
---

## è¯¦ç»†è¯´æ˜

"""
    
    for i, item in enumerate(trending_items, 1):
        topics_str = ", ".join(item.get("topics", [])[:5])
        md_content += f"""
### {i}. [{item['name']}]({item['url']})

- **Stars**: {item['stars']:,}
- **Language**: {item['language']}
- **Topics**: {topics_str}
- **Last Updated**: {item['updated_at']}
- **Description**: {item['description']}

---
"""
    
    md_content += f"""
## æ•°æ®æ¥æº

- GitHub Search API
- æœç´¢æ¡ä»¶ï¼štopic:devops stars:>1000
- æ’åºï¼šæŒ‰ Star æ•°é™åº

## è‡ªåŠ¨æ›´æ–°

æœ¬æŠ¥å‘Šæ¯ 6 å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ã€‚

---
*Generated by DevOps Trending Collector*
"""
    
    return md_content

def main():
    workspace_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    output_file = os.path.join(workspace_dir, "DevOps", "trending.md")
    
    print(f"Fetching GitHub DevOps trending projects...")
    trending_items = fetch_github_trending()
    
    if trending_items:
        md_content = generate_markdown(trending_items)
        
        with open(output_file, "w", encoding="utf-8") as f:
            f.write(md_content)
        
        print(f"Successfully updated {output_file}")
        print(f"Collected {len(trending_items)} projects")
    else:
        print("No trending items found or API error occurred")

if __name__ == "__main__":
    main()
